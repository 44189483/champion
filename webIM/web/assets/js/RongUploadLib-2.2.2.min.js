var RongIMLib;(function(a){var b=(function(){function c(g,d){this.store={};this.usingKey="";this.options={uptoken:"",get_new_uptoken:false,domain:"",max_file_size:"100mb",max_retries:3,dragdrop:true,drop_element:"",chunk_size:"4mb",auto_start:true,container:"",browse_button:"",conversationType:0,targetId:""};var f=this;var e=document.getElementsByTagName("head")[0];var h=document.createElement("script");h.src="http://cdn.ronghub.com/plupload.min.js";h.onload=h.onreadystatechange=function(){if(!this.readyState||this.readyState=="loaded"||this.readyState=="complete"){var i=document.createElement("script");i.src="http://cdn.ronghub.com/qiniu.min.js";i.onload=h.onreadystatechange=function(){if(!this.readyState||this.readyState=="loaded"||this.readyState=="complete"){g&&a.RongIMClient.getInstance().getFileToken(a.FileType.IMAGE,{onSuccess:function(j){f.store.imgOpts=g;g.uptoken=j.token;f.createOptions(g,"IMAGE")},onError:function(j){}});d&&a.RongIMClient.getInstance().getFileToken(a.FileType.FILE,{onSuccess:function(j){d.uptoken=j.token;f.store.fileOpts=d;f.createOptions(d,"FILE")},onError:function(j){}})}};e.appendChild(i)}};e.appendChild(h)}c.init=function(e,d){c._instance=new c(e,d)};c.imageCompressToBase64=function(d,e){c.getInstance().getThumbnail(d,60000,function(h,g){var f=new RegExp("^data:image/[^;]+;base64,");var i=g.replace(f,"");e(i)})};c.getInstance=function(){return c._instance};c.prototype.setListeners=function(d){this.listener=d};c.prototype.start=function(f,d){var e=this;this.conversationType=f;this.targetId=d;this.store[this.uploadType].start()};c.prototype.cancel=function(d){this.store[this.uploadType].removeFile(d)};c.prototype.cancelAll=function(h){var e=this.store[this.uploadType],g=e.files;for(var f=0,d=g.length;f<d;f++){e.removeFile(g[f])}h()};c.prototype.reload=function(f,d){var e=this;f&&e.store.IMAGE&&e.store.IMAGE.destroy();e.store.imgOpts&&f=="IMAGE"&&a.RongIMClient.getInstance().getFileToken(a.FileType.IMAGE,{onSuccess:function(g){e.store.imgOpts["uptoken"]=g.token;e.createOptions(e.store.imgOpts,"IMAGE")},onError:function(g){}});d&&e.store.FILE&&e.store.FILE.destroy();e.store.fileOpts&&d=="FILE"&&a.RongIMClient.getInstance().getFileToken(a.FileType.FILE,{onSuccess:function(g){e.store.fileOpts["uptoken"]=g.token;e.createOptions(e.store.fileOpts,"FILE")},onError:function(g){}})};c.prototype.destroy=function(){var e=this;for(var d in e.store){e.store[d].destroy();delete e.store[d]}};c.prototype.postImage=function(d,f,i,e,h){var g=this;a.RongIMClient.getInstance().getFileToken(a.FileType.IMAGE,{onSuccess:function(j){new a.RongAjax({token:j.token,base64:d}).send(function(k){var l={uploadType:"IMAGE",fileName:k.hash,isBase64Data:true};g.createMessage(l,f,function(m){a.RongIMClient.getInstance().sendMessage(i,e,m,{onSuccess:function(n){h(k,n)},onError:function(n,o){h(k,o,n)}})})})},onError:function(j){}})};c.prototype.createOptions=function(g,e){var f=this;if(!g){return}for(var d in f.options){g[d]||(g[d]=f.options[d])}switch(e){case"IMAGE":!g.filters&&(g.filters={mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],prevent_duplicates:true});g.domain||(g.domain="http://rongcloud-image.qiniudn.com/");g.uploadType=e;f.store[e]=f.createUploadFactory(g,1);break;case"FILE":g.filters={mime_types:[],prevent_duplicates:true};g.domain||(g.domain="http://o83059m7d.bkt.clouddn.com/");g.uploadType=e;f.store[e]=f.createUploadFactory(g,2);break;case"VIDEO":!g.filters&&(g.filters={mime_types:[{title:"Video files",extensions:"flv,mpg,mpeg,avi,wmv,mov,asf,rm,rmvb,mkv,m4v,mp4"}],prevent_duplicates:true});g.uploadType=e;f.store[e]=f.createUploadFactory(g,3);break;case"AUDIO":!g.filters&&(g.filters={mime_types:[{title:"Audio files",extensions:"mp3,wav,amr,wma"}],prevent_duplicates:true});g.uploadType=e;f.store[e]=f.createUploadFactory(g,4);break}};c.prototype.createUploadFactory=function(h,f){var g=this;var e={runtimes:h.runtimes,browse_button:h.browse_button,get_new_uptoken:h.get_new_uptoken,domain:h.domain,container:h.container,uptoken:h.uptoken,max_file_size:h.max_file_size,max_retries:h.max_retries,dragdrop:h.dragdrop,unique_names:true,drop_element:h.drop_element,chunk_size:h.chunk_size,auto_start:false,uploadType:h.uploadType,init:{FilesAdded:function(i,l){var k=i.getOption(),j="";g.uploadType=k.uploadType;plupload.each(l,function(m){m.uploadType=g.uploadType;g.listener.onFileAdded(m)})},BeforeUpload:function(i,k){var j="";k.oldName=k.name;if(k.name.lastIndexOf(".")>-1){j=k.id+k.name.substr(k.name.lastIndexOf("."))}else{j=k.id}k.name=j;k.uploadType=g.uploadType;g.listener.onBeforeUpload(k)},UploadProgress:function(i,j){j.uploadType=g.uploadType;g.listener.onUploadProgress(j)},FileUploaded:function(i,k,m){var l=i.getOption();if(k.name.lastIndexOf(".")>-1){var j=k.target_name.lastIndexOf(".");e.fileName=k.target_name.substr(0,j)+"."+k.target_name.substr(j+1).toLocaleLowerCase()}else{e.fileName=k.id}k.uploadType=g.uploadType;g.createMessage(e,k,function(n){a.RongIMClient.getInstance().sendMessage(g.conversationType,g.targetId,n,{onSuccess:function(o){g.listener.onFileUploaded(k,o)},onError:function(p,o){g.listener.onFileUploaded(k,o,p)}})})},Error:function(i,k,j){g.listener.onError(i,k,j)},UploadComplete:function(){g.listener.onUploadComplete()},Key:function(i,j){}}};h.filters&&(e.filters=h.filters);if(f==1){return Qiniu.uploader(e)}else{var d=new QiniuJsSDK();return d.uploader(e)}};c.prototype.createMessage=function(e,d,g){var f=null;switch(e.uploadType){case"IMAGE":a.RongIMClient.getInstance().getFileUrl(a.FileType.IMAGE,e.fileName,null,{onSuccess:function(h){if(e.isBase64Data){c.imageCompressToBase64(d,function(i){f=new a.ImageMessage({content:i,imageUri:h.downloadUrl});g(f)})}else{c.imageCompressToBase64(d.getNative(),function(i){f=new a.ImageMessage({content:i,imageUri:h.downloadUrl});g(f)})}},onError:function(h){}});break;case"FILE":a.RongIMClient.getInstance().getFileUrl(a.FileType.FILE,e.fileName,encodeURIComponent(d.oldName),{onSuccess:function(i){var h=(e.fileName&&e.fileName.split(".")[1])||"";f=new a.FileMessage({name:d.oldName,size:d.size,type:h,fileUrl:i.downloadUrl});g(f)},onError:function(h){}});break;case"VIDEO":break;case"AUDIO":break}};c.prototype.getThumbnail=function(i,h,j){var e=document.createElement("canvas"),f=e.getContext("2d"),g=this;var d=new Image();d.onload=function(){var n;var k;var o=d.width*d.height;var r=0,s=0,t=240,u=240;if(o>h){var m=Math.sqrt(o/h);m=Math.ceil(m*100)/100;n=d.width/m;k=d.height/m}else{n=d.width;k=d.height}e.width=n;e.height=k;f.drawImage(d,0,0,n,k);try{if(e.width>t||e.height>u){if(n>t){s=(n-t)/2;n=t}if(k>u){r=(k-u)/2;k=u}var l=f.getImageData(s,r,n,k);f.createImageData(n,k);e.width=n;e.height=k;f.putImageData(l,0,0)}var q=e.toDataURL("image/jpeg",0.5);j(i,q)}catch(p){j(i,null)}};d.src=g.getFullPath(i)};c.prototype.getFullPath=function(d){window.URL=window.URL||window.webkitURL;if(window.URL&&window.URL.createObjectURL){return window.URL.createObjectURL(d)}else{return null}};return c})();a.RongUploadLib=b})(RongIMLib||(RongIMLib={}));